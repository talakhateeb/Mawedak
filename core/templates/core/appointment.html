{% extends "core/base.html" %}
{% load static %}

{% block title %}حجز موعد - موعدك{% endblock %}

{% block content %}
<section class="content_section">
  <div class="container">
    <h2 class="text-center mb-4">حجز موعد</h2>
    <p class="text-center mb-5">يرجى ملء النموذج أدناه لحجز موعدك بسهولة وسرعة.</p>
    <form action="{% url 'appointment' %}" method="post">
      {% csrf_token %}
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="fullName" class="form-label">الاسم الكامل</label>
          <input
            type="text"
            class="form-control"
            id="fullName"
            name="fullName"
            placeholder="أدخل اسمك الكامل"
            required
          />
        </div>
        <div class="col-md-6">
          <label for="email" class="form-label">البريد الإلكتروني</label>
          <input
            type="email"
            class="form-control"
            id="email"
            name="email"
            placeholder="أدخل بريدك الإلكتروني"
            required
          />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="phone" class="form-label">رقم الهاتف</label>
          <input
            type="text"
            class="form-control"
            id="phone"
            name="phone"
            placeholder="أدخل رقم هاتفك"
            required
          />
        </div>
        <div class="col-md-6">
          <label for="department" class="form-label">اختر الدائرة</label>
          <select
            class="form-select"
            id="department"
            name="department"
            required
          >
            <option value="">جار التحميل...</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="service" class="form-label">اختر الخدمة</label>
          <select
            class="form-select"
            id="service"
            name="service"
            required
          >
            <option value="">اختر خدمة</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="date" class="form-label">اختر التاريخ</label>
          <input
            type="date"
            class="form-control"
            id="date"
            name="date"
            required
          />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="time" class="form-label">اختر الوقت</label>
          <input
            type="time"
            class="form-control"
            id="time"
            name="time"
            required
          />
        </div>
      </div>
      <div class="mb-3">
        <label for="notes" class="form-label">ملاحظات</label>
        <textarea
          class="form-control"
          id="notes"
          name="notes"
          rows="4"
          placeholder="أدخل أي ملاحظات إضافية"
        ></textarea>
      </div>
      <div class="text-center">
        <button type="submit" class="btn btn-primary btn-lg">حجز موعد</button>
      </div>
    </form>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('Page loaded, starting department fetch.');

    const departmentSelect = document.getElementById('department');
    const serviceSelect = document.getElementById('service');

    // Fetch departments
    fetch('/api/departments/')
      .then((response) => {
        if (!response.ok) {
          throw new Error(`Failed to fetch departments: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log('Departments fetched successfully.');
        departmentSelect.innerHTML = '<option value="">اختر دائرة</option>';
        data.forEach((department) => {
          const option = document.createElement('option');
          option.value = department.id;
          option.textContent = department.name;
          departmentSelect.appendChild(option);
        });
      })
      .catch((error) => {
        console.error('Error fetching departments:', error.message);
        departmentSelect.innerHTML =
          '<option value="">حدث خطأ في تحميل الدوائر</option>';
      });

    // Fetch services based on the selected department
    departmentSelect.addEventListener('change', function () {
      const departmentId = this.value;

      serviceSelect.innerHTML = '<option value="">اختر خدمة</option>'; // Clear existing options

      if (!departmentId) return; // No department selected, nothing to fetch

      fetch(`/api/services/${departmentId}/`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`Failed to fetch services: ${response.statusText}`);
          }
          return response.json();
        })
        .then((data) => {
          if (data.length === 0) {
            const option = document.createElement('option');
            option.textContent = 'لا توجد خدمات في هذه الدائرة';
            serviceSelect.appendChild(option);
          } else {
            data.forEach((service) => {
              const option = document.createElement('option');
              option.value = service.id;
              option.textContent = service.name;
              serviceSelect.appendChild(option);
            });
          }
        })
        .catch((error) => {
          console.error('Error fetching services:', error.message);
          const option = document.createElement('option');
          option.textContent = 'حدث خطأ في تحميل الخدمات';
          serviceSelect.appendChild(option);
        });
    });
  });
</script>
{% endblock %}
